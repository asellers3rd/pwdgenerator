name: Build AppImage

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3 python3-pip python3-tk \
          python3-venv python3-dev \
          libfuse2 libx11-dev libxext-dev libxrandr-dev \
          libxfixes-dev libxcursor-dev libxinerama-dev \
          libxi-dev libglib2.0-dev libgtk-3-dev \
          build-essential wget git curl

    - name: Install AppImageBuilder
      run: |
        pip3 install --no-cache-dir appimage-builder

    - name: Install AppImageTool
      run: |
        wget -q https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage \
        -O appimagetool && \
        chmod +x appimagetool && \
        sudo mv appimagetool /usr/local/bin/

    - name: Install Python dependencies
      run: |
        pip3 install --no-cache-dir pyinstaller customtkinter

    - name: Build with PyInstaller
      run: |
        pyinstaller --noconfirm --onefile --windowed pwdgenerator.py \
          --name "Password_Generator" \
          --icon icon.png

    - name: Prepare AppDir
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/icons
        cp dist/Password_Generator AppDir/usr/bin/
        cp icon.png AppDir/usr/share/icons/icon.png

    - name: Build AppImage
      run: |
        appimage-builder --recipe AppImageBuilder.yml
        appimagetool AppDir

    - name: Upload AppImage to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: '**/*.AppImage'
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
