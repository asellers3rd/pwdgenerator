name: Build AppImage

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 📥 Checkout code (works because no custom container)
    - name: Checkout repository
      uses: actions/checkout@v4

    # 🛠 Install system dependencies
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git python3 python3-pip fuse wget

    # 🛠 Install AppImageBuilder
    - name: Install AppImageBuilder
      run: |
        pip3 install appimage-builder

    # 🐍 Install Python dependencies
    - name: Install Python dependencies
      run: |
        pip3 install pyinstaller customtkinter

    # 📦 Build binary with PyInstaller
    - name: Build with PyInstaller
      run: |
        cd pwdgeneratorapp
        pyinstaller --noconfirm --onefile --windowed pwdgenerator.py \
          --name "Password_Generator" \
          --icon icon.png

    # 📂 Prepare AppDir
    - name: Prepare AppDir
      run: |
        mkdir -p AppDir/usr/bin
        cp pwdgeneratorapp/dist/Password_Generator AppDir/usr/bin/

    # 📦 Build AppImage
    - name: Build AppImage
      run: |
        cp pwdgeneratorapp/AppImageBuilder.yml AppImageBuilder.yml
        appimage-builder --recipe AppImageBuilder.yml

    # 🚀 Upload AppImage to GitHub Release
    - name: Upload AppImage to Release
      uses: softprops/action-gh-release@v2
      with:
        files: '*.AppImage'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
