name: Build AppImage

on:
  push:
    tags:
      - 'v*.*.*' # Trigger only when you push version tags like v1.0.0
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: appimagecrafters/appimage-builder:latest
      options: --privileged # AppImage needs fuse and special privileges

    steps:
    # ğŸ“¥ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # ğŸ Set up Python (already included in the container, but ensure correct version)
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r pwdgeneratorapp/requirements.txt
        pip3 install pyinstaller

    # ğŸ“¦ Build binary with PyInstaller
    - name: Build with PyInstaller
      run: |
        cd pwdgeneratorapp
        pyinstaller --noconfirm --onefile --windowed pwdgenerator.py \
        --name "Password_Generator" \
        --icon icon.png

    # ğŸ“‚ Prepare AppDir
    - name: Prepare AppDir
      run: |
        mkdir -p AppDir/usr/bin
        cp pwdgeneratorapp/dist/Password_Generator AppDir/usr/bin/

    # ğŸ“¦ Build AppImage
    - name: Build AppImage
      run: |
        echo "Skipping redundant copy of AppImageBuilder.yml"
        appimage-builder --recipe AppImageBuilder.yml

    # ğŸš€ Upload AppImage as GitHub Release asset
    - name: Upload AppImage to Release
      uses: softprops/action-gh-release@v2
      with:
        files: '*.AppImage'
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
